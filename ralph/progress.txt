## Completed Tasks

### Task 1: Redirect user with no access for status-pages/[id]
- **PRD Item**: "When a user is on wrong dashboard /status-pages/[id] redirect him to /status-pages"
- **Status**: COMPLETED
- **Commit**: b72b1bf5
- **Changes Made**:
  - Modified `apps/dashboard/src/app/(dashboard)/status-pages/[id]/layout.tsx`
  - Changed from `prefetchQuery` to `fetchQuery` to properly check page access
  - Added try-catch block to handle errors when user doesn't have access to the page
  - Redirects to `/status-pages` instead of throwing an error when:
    - Page doesn't exist
    - User doesn't have access to the page (wrong workspace)

### Task 2: Database Schema - Add unsubscribedAt timestamp field
- **PRD Item**: "Add unsubscribedAt timestamp field to page_subscribers table"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/db/src/schema/page_subscribers/page_subscribers.ts`:
    - Added `unsubscribedAt: integer("unsubscribed_at", { mode: "timestamp" })` field
  - Created migration file `packages/db/drizzle/0053_groovy_doctor_strange.sql`:
    - SQL: `ALTER TABLE page_subscriber ADD unsubscribed_at integer;`
  - Updated `packages/db/drizzle/meta/_journal.json` with new migration entry
  - Created snapshot file `packages/db/drizzle/meta/0053_snapshot.json` with updated schema

### Task 3: API - Unsubscribe Mutation
- **PRD Item**: "Create public unsubscribe mutation in statusPage router"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/api/src/router/statusPage.ts`:
    - Added `unsubscribe` publicProcedure mutation
    - Accepts input: `z.object({ token: z.string().uuid() })`
    - Finds subscriber by token with page relation
    - Validates token exists and subscriber has `acceptedAt` set (verified)
    - Validates subscriber is not already unsubscribed
    - Sets `unsubscribedAt` to current timestamp
    - Returns success response with page title

### Task 4: API - Get Subscriber By Token
- **PRD Item**: "Create public query to get subscriber info for confirmation page"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/api/src/router/statusPage.ts`:
    - Added `getSubscriberByToken` publicProcedure query
    - Accepts input: `z.object({ token: z.string().uuid() })`
    - Finds subscriber by token with page relation
    - Returns `null` if subscriber not found or already unsubscribed
    - Returns `{ pageName, maskedEmail }` for valid subscribers
    - Masks email by showing first character + `***` + `@domain` (e.g., `j***@example.com`)

### Task 5: API - One-Click Unsubscribe Endpoint
- **PRD Item**: "Create POST endpoint for RFC 8058 one-click unsubscribe"
- **Status**: COMPLETED
- **Changes Made**:
  - Created `apps/server/src/routes/public/unsubscribe.ts`:
    - New public POST endpoint at `/public/unsubscribe/:token`
    - Handles RFC 8058 one-click unsubscribe requests from email clients
    - Validates token is a valid UUID format
    - Finds subscriber by token in database
    - Validates subscriber exists and has verified subscription (`acceptedAt` set)
    - Returns 200 OK if already unsubscribed (idempotent behavior)
    - Sets `unsubscribedAt` timestamp on successful unsubscribe
    - Returns appropriate error codes: 400 for invalid token/unverified, 404 for not found
  - Modified `apps/server/src/routes/public/index.ts`:
    - Imported and registered the unsubscribe route
    - Route available at `/public/unsubscribe/:token`

### Task 6: Email Template - Unsubscribe Link
- **PRD Item**: "Add unsubscribe link footer to status report emails"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/emails/emails/status-report.tsx`:
    - Added `Link` and `Section` imports from `@react-email/components`
    - Added `unsubscribeUrl: z.string().url().optional()` to `StatusReportSchema`
    - Added `unsubscribeUrl` prop to component destructuring
    - Added footer section with unsubscribe link (conditionally rendered when `unsubscribeUrl` is provided)
    - Styled footer with small (12px), muted gray text (#6b7280) for appropriate visual hierarchy
    - Updated `PreviewProps` to include sample `unsubscribeUrl` for email preview
    - Removed the old `// TODO: add unsubscribe link!` comment

### Task 7: Email Client - List-Unsubscribe Headers
- **PRD Item**: "Add RFC 8058 headers for one-click unsubscribe in email clients"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/emails/src/client.tsx`:
    - Updated `sendStatusReportUpdate` method signature to accept `subscribers: Array<{ email: string; token: string }>` instead of `to: string[]`
    - Added optional `baseUrl` parameter (defaults to `https://api.openstatus.dev`)
    - For each subscriber, builds unsubscribe URL: `${baseUrl}/public/unsubscribe/${subscriber.token}`
    - Added `List-Unsubscribe` header with the unsubscribe URL
    - Added `List-Unsubscribe-Post: List-Unsubscribe=One-Click` header for RFC 8058 compliance
    - Passes `unsubscribeUrl` prop to `StatusReportEmail` component for each subscriber
  - Updated all callers of `sendStatusReportUpdate`:
    - `apps/server/src/routes/v1/statusReports/post.ts`: Pass subscribers with email and token, filter out null tokens
    - `apps/server/src/routes/v1/statusReportUpdates/post.ts`: Pass subscribers with email and token, filter out null tokens
    - `apps/server/src/routes/v1/maintenances/post.ts`: Pass subscribers with email and token, filter out null tokens
    - `apps/server/src/routes/v1/statusReports/update/post.ts`: Pass subscribers with email and token, filter out null tokens
    - `packages/api/src/router/email/index.ts`: Updated `sendStatusReport` and `sendMaintenance` mutations to pass subscribers with tokens, filter out null tokens

### Task 8: Query Updates - Filter Unsubscribed
- **PRD Item**: "Update email-sending queries to exclude unsubscribed users"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `apps/server/src/routes/v1/statusReports/post.ts`:
    - Added `isNull(pageSubscriber.unsubscribedAt)` to the where clause when fetching subscribers
    - This ensures unsubscribed users are excluded from status report email notifications
  - Modified `apps/server/src/routes/v1/statusReportUpdates/post.ts`:
    - Added `isNull` import from `@openstatus/db`
    - Added `isNull(pageSubscriber.unsubscribedAt)` to the where clause when fetching subscribers
    - This ensures unsubscribed users are excluded from status report update email notifications

### Task 9: Frontend - Unsubscribe Confirmation Page
- **PRD Item**: "Create unsubscribe confirmation page in status-page app"
- **Status**: COMPLETED
- **Changes Made**:
  - Created `apps/status-page/src/app/(status-page)/[domain]/(public)/unsubscribe/[token]/page.tsx`:
    - Client component using React Query and TRPC
    - Fetches subscriber info using `getSubscriberByToken` query on mount
    - Displays loading state while fetching
    - Shows error state for invalid/expired tokens or already unsubscribed
    - Shows confirmation view with page name and masked email
    - "Cancel" button to go back, "Confirm Unsubscribe" button to proceed
    - Calls `unsubscribe` mutation on button click with loading state
    - Shows success state after successful unsubscription
    - Shows error state if mutation fails with error message
  - Created `apps/status-page/src/app/(status-page)/[domain]/(public)/unsubscribe/[token]/layout.tsx`:
    - Client layout component matching the verify page pattern
    - Fetches page info using `statusPage.get` query
    - Displays page title and description in Status header

### Task 10: Dashboard - Subscriber Table Update
- **PRD Item**: "Show unsubscribed status in dashboard subscribers table"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `apps/dashboard/src/components/data-table/subscribers/columns.tsx`:
    - Added `Badge` component import from `@/components/ui/badge`
    - Added new "Status" column after "Email" column
    - Displays "Unsubscribed {date}" badge (destructive variant) if `unsubscribedAt` is set
    - Displays "Pending" badge (outline variant) if `acceptedAt` is not set (unverified subscriber)
    - Displays "Active" badge (secondary variant) for verified, subscribed users
  - Modified `apps/dashboard/src/app/(dashboard)/status-pages/[id]/subscribers/page.tsx`:
    - Added `unsubscribedAt: null` field to `EXAMPLES` mock data array to satisfy TypeScript types

### Task 11: Re-subscription Flow
- **PRD Item**: "Handle re-subscription after unsubscribe"
- **Status**: COMPLETED
- **Changes Made**:
  - Modified `packages/api/src/router/statusPage.ts`:
    - Updated `subscribe` mutation to handle re-subscription scenarios
    - Changed from checking only active subscriptions to checking all existing subscribers by email
    - When an unsubscribed user re-subscribes:
      - Clears `unsubscribedAt` field (set to null)
      - Resets `acceptedAt` to null to require re-verification
      - Regenerates `token` for security
      - Updates `expiresAt` for the new verification window
    - When a pending (unverified) user re-subscribes:
      - Regenerates `token` for security
      - Updates `expiresAt` for the new verification window
    - Active subscribed users still receive "Email already subscribed" error
    - New subscriptions still create a fresh record

### Task 12: Testing - Unit Tests
- **PRD Item**: "Add unit tests for unsubscribe API endpoints"
- **Status**: COMPLETED
- **Changes Made**:
  - Created `packages/api/src/router/statusPage.unsubscribe.test.ts`:
    - Test suite for `getSubscriberByToken` query:
      - Tests returning subscriber info with masked email for valid token
      - Tests returning null for non-existent token
      - Tests returning null for already unsubscribed user
      - Tests email masking with single character local part
      - Tests email masking with long local part
    - Test suite for `unsubscribe` mutation:
      - Tests successful unsubscription of verified subscriber
      - Tests failure for non-existent token
      - Tests failure for unverified subscriber
      - Tests failure for already unsubscribed user
      - Tests that unsubscribedAt is set to current timestamp
    - Test suite for email masking logic:
      - Tests correct masking pattern (j***@example.com)
      - Tests handling of empty local part
      - Tests preservation of domain in masked email
      - Tests handling of complex domains (subdomain.example.co.uk)
    - Test suite for token validation:
      - Tests UUID format validation for valid tokens
      - Tests rejection of invalid UUID format
    - Uses bun:test framework with beforeAll/afterAll for setup/teardown
    - Creates test page and subscribers with proper cleanup

### Task 13: Testing - Integration Tests
- **PRD Item**: "Add integration tests for email headers and filtering"
- **Status**: COMPLETED
- **Changes Made**:
  - Created `packages/emails/src/client.integration.test.tsx`:
    - Test suite for List-Unsubscribe headers:
      - Tests correct List-Unsubscribe header URL construction
      - Tests List-Unsubscribe-Post header for RFC 8058 compliance
      - Tests custom baseUrl support
      - Tests unique unsubscribe URL generation per subscriber
    - Test suite for unsubscribe link in email body:
      - Tests unsubscribe link inclusion when URL is provided
      - Tests no unsubscribe section when URL is not provided
      - Tests unsubscribe link is rendered as clickable (href attribute)
      - Tests proper styling (muted gray color #6b7280)
    - Test suite for email content validation:
      - Tests all required email fields are included
      - Tests all status types render correctly (investigating, identified, monitoring, resolved, maintenance)
  - Created `apps/server/src/routes/v1/statusReports/subscriber-filtering.integration.test.ts`:
    - Test suite for subscriber filtering in email notifications:
      - Tests excluding unsubscribed users from email queries
      - Tests excluding pending (unverified) users from email queries
      - Tests unsubscribed users with acceptedAt are still excluded
      - Tests query without unsubscribedAt filter returns all verified subscribers
      - Tests filtering subscribers with valid tokens
    - Test suite for subscriber state transitions:
      - Tests re-subscribing after unsubscription
      - Tests unsubscription timestamp tracking
    - Test suite for query performance:
      - Tests index-friendly query conditions execute quickly
    - Uses bun:test framework with beforeAll/afterAll for setup/teardown
    - Creates test page with multiple subscriber states (active, unsubscribed, pending)

### Task 14: Testing - E2E Tests
- **PRD Item**: "Add end-to-end tests for full unsubscribe flow"
- **Status**: COMPLETED
- **Changes Made**:
  - Created `packages/api/src/router/statusPage.e2e.test.ts`:
    - Test suite for full unsubscribe flow (subscribe -> verify -> receive email -> unsubscribe):
      - Tests user subscribes to status page (creates subscriber with token)
      - Tests user verifies their email subscription (sets acceptedAt)
      - Tests verified subscriber is included in email recipient list
      - Tests user clicks unsubscribe and sets unsubscribedAt timestamp
      - Tests unsubscribed user is excluded from email recipient list
    - Test suite for confirmation page displays correct information:
      - Tests confirmation page displays correct page name from database
      - Tests confirmation page displays masked email (first char + *** + @domain)
      - Tests email masking works for single character local part
      - Tests email masking works for long local part
    - Test suite for clicking confirm sets unsubscribedAt timestamp:
      - Tests before clicking confirm, unsubscribedAt is null
      - Tests after clicking confirm, unsubscribedAt is set to current timestamp
      - Tests timestamp is within expected time range
      - Tests subscriber state transitions correctly through the flow
    - Test suite for unsubscribed user does not receive new emails:
      - Tests email query returns only active subscribers with valid tokens
      - Tests unsubscribed users are filtered out even with acceptedAt set
      - Tests pending users are filtered out (not verified)
      - Tests email recipients list includes token for unsubscribe URL generation
    - Test suite for re-subscription after unsubscribe flow:
      - Tests complete subscribe -> unsubscribe -> resubscribe cycle
      - Tests user is excluded from emails after unsubscribe
      - Tests user is excluded while pending re-verification
      - Tests user is included after re-verification
      - Tests new token is generated on re-subscription
    - Test suite for invalid token handling:
      - Tests non-existent token returns no subscriber
      - Tests invalid UUID format is handled gracefully
      - Tests already unsubscribed token returns subscriber with unsubscribedAt set
    - Uses bun:test framework with beforeAll/afterAll for setup/teardown
    - Creates test page and multiple subscribers for comprehensive flow testing
