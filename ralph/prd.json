[
  {
    "category": "setup",
    "spec": "notifications-enhancement-spec.md",
    "description": "Create @openstatus/notification-base package with types and utilities",
    "steps": [
      "Create /packages/notification-base directory structure",
      "Create package.json with dependencies: date-fns, zod, @openstatus/db, @openstatus/regions",
      "Create tsconfig.json matching other packages in monorepo",
      "Create src/index.ts to export all types and utilities",
      "Create src/types.ts with NotificationContext, NotificationContextWithIncident, FormattedMessageData, NotificationType types",
      "Create src/schemas.ts for Zod validation schemas (if needed)",
      "Add package to root package.json workspace"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Implement duration formatting utilities in notification-base",
    "steps": [
      "Create src/utils/duration.ts",
      "Implement formatDuration(durationMs, options?) function that converts milliseconds to human-readable format like '2h 15m 30s'",
      "Handle edge cases: 0ms, very short durations (<1s), very long durations (>1 day)",
      "Support maxUnits option to limit displayed units (default 3)",
      "Return format: show only non-zero units (e.g., '5m' not '0h 5m 0s')",
      "Add JSDoc comments with examples"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Implement timestamp formatting utilities in notification-base",
    "steps": [
      "Create src/utils/timestamp.ts",
      "Import format from date-fns",
      "Implement formatTimestamp(cronTimestamp, options?) that converts epoch milliseconds to 'MMM dd, yyyy at HH:mm UTC' format",
      "Handle invalid timestamps gracefully",
      "Add JSDoc comments with examples"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Implement incident duration calculation utilities in notification-base",
    "steps": [
      "Create src/utils/incident.ts",
      "Import Incident type from @openstatus/db/schema",
      "Import formatDuration from ./duration",
      "Implement getIncidentDuration(incident, currentTime?) function",
      "Return null if incident.startedAt is missing",
      "Calculate duration using incident.resolvedAt if present, otherwise use currentTime or Date.now()",
      "Handle both Date objects and timestamps for startedAt",
      "Return formatted duration string using formatDuration()",
      "Add JSDoc comments"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Implement common message data builder in notification-base",
    "steps": [
      "Create src/utils/message.ts",
      "Import Incident type from @openstatus/db/schema",
      "Import getRegionInfo from @openstatus/regions",
      "Import NotificationContext, FormattedMessageData types",
      "Import formatTimestamp and getIncidentDuration utilities",
      "Implement formatStatusCode(statusCode?) helper function with common HTTP status descriptions",
      "Implement buildCommonMessageData(context, options?) function",
      "Extract monitor.name, monitor.url, statusCode, message, cronTimestamp, region, latency from context",
      "Use getRegionInfo() to format region display as 'code (location)'",
      "Format status code with description (e.g., '503 Service Unavailable')",
      "Format latency with toLocaleString() and 'ms' suffix",
      "Build dashboard URL as https://app.openstatus.dev/monitors/{monitor.id}",
      "Only include incidentDuration if options.incident exists AND incident.resolvedAt is present",
      "Return FormattedMessageData object",
      "Add JSDoc comments"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update checker/alerting to fetch and pass incident data",
    "steps": [
      "Open /apps/workflows/src/checker/alerting.ts",
      "Import Incident type from @openstatus/db/schema",
      "Locate triggerNotifications() function",
      "Add logic to fetch incident by ID for recovery and degraded notification types",
      "Use db.query.incident.findFirst() with where clause eq(schema.incident.id, Number.parseInt(incidentId))",
      "Pass incident object (not just incidentId string) to provider functions",
      "Make incident parameter optional in function calls to maintain backward compatibility",
      "Ensure error handling for missing incidents"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update provider function type signatures in checker/utils",
    "steps": [
      "Open /apps/workflows/src/checker/utils.ts",
      "Import Incident type from @openstatus/db/schema",
      "Locate providerToFunction mapping object",
      "Update type signatures for sendAlert, sendRecovery, sendDegraded to include optional incident parameter",
      "Change incidentId?: string to incident?: Incident in function signatures",
      "Ensure all 11 providers are updated in the mapping"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Create Slack block builder utilities",
    "steps": [
      "Create /packages/notifications/slack/src/blocks.ts",
      "Import FormattedMessageData from @openstatus/notification-base",
      "Implement escapeSlackText() helper to escape &, <, > as HTML entities",
      "Implement buildAlertBlocks(data) returning array of Slack blocks",
      "Alert blocks: header ('üî¥ Monitor Down'), section with monitor link, divider, section with 4 fields (Status/Region/Latency/Time in 2x2 grid), section with error in code block, actions with dashboard button",
      "Implement buildRecoveryBlocks(data) returning array of Slack blocks",
      "Recovery blocks: header ('‚úÖ Monitor Recovered'), section with monitor link, optional duration section if data.incidentDuration exists, divider, section with 4 fields, actions with dashboard button",
      "Implement buildDegradedBlocks(data) returning array of Slack blocks",
      "Degraded blocks: header ('‚ö†Ô∏è Monitor Degraded'), section with monitor link, optional duration section, divider, section with 4 fields, actions with dashboard button",
      "Use proper Slack mrkdwn syntax: *bold*, <URL|text> for links, ``` for code blocks",
      "Use plain_text type for header and button text with emoji: true",
      "Use mrkdwn type for section text and fields",
      "Add JSDoc comments"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update Slack provider to use enhanced blocks and incident data",
    "steps": [
      "Open /packages/notifications/slack/src/index.ts",
      "Add @openstatus/notification-base to package.json dependencies",
      "Import buildCommonMessageData from @openstatus/notification-base",
      "Import buildAlertBlocks, buildRecoveryBlocks, buildDegradedBlocks from ./blocks",
      "Import Incident type from @openstatus/db/schema",
      "Update sendAlert function signature to accept incident?: Incident parameter",
      "In sendAlert: call buildCommonMessageData(context) to get formatted data",
      "In sendAlert: call buildAlertBlocks(data) to get blocks array",
      "In sendAlert: send blocks to webhook instead of current simple message",
      "Update sendRecovery function signature to accept incident?: Incident parameter",
      "In sendRecovery: call buildCommonMessageData(context, { includeIncidentDuration: true, incident }) to get formatted data",
      "In sendRecovery: call buildRecoveryBlocks(data) to get blocks array",
      "In sendRecovery: send blocks to webhook",
      "Update sendDegraded function signature to accept incident?: Incident parameter",
      "In sendDegraded: call buildCommonMessageData(context, { includeIncidentDuration: true, incident }) to get formatted data",
      "In sendDegraded: call buildDegradedBlocks(data) to get blocks array",
      "In sendDegraded: send blocks to webhook",
      "Remove biome-ignore comments for incidentId since we now use incident"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Create Discord embed builder utilities",
    "steps": [
      "Read the https://birdie0.github.io/discord-webhooks-guide/structure/embeds.html docs",
      "Create /packages/notifications/discord/src/embeds.ts",
      "Import FormattedMessageData from @openstatus/notification-base",
      "Define DiscordEmbed interface with title, description, color, fields array, timestamp, footer, url properties",
      "Implement buildAlertEmbed(data) returning DiscordEmbed",
      "Alert embed: title 'üî¥ Monitor Down', description with markdown link **[name](url)**, color 15548997 (red), fields array with Status/Region/Latency (inline: true) and Error Message (inline: false), timestamp as ISO 8601, footer with text 'OpenStatus', url as dashboardUrl",
      "Implement buildRecoveryEmbed(data) returning DiscordEmbed",
      "Recovery embed: title '‚úÖ Monitor Recovered', description with markdown link, color 5763719 (green), optional Downtime field if data.incidentDuration exists (inline: false), Status/Region/Latency fields (inline: true), timestamp, footer, url",
      "Implement buildDegradedEmbed(data) returning DiscordEmbed",
      "Degraded embed: title '‚ö†Ô∏è Monitor Degraded', description with markdown link, color 16776960 (yellow), optional Previous Incident Duration field, Status/Region/Latency fields (inline: true), timestamp, footer, url",
      "Ensure all field names are concise ('Status Code', 'Region', 'Latency', not 'URL:')",
      "Use new Date().toISOString() for timestamp",
      "Add JSDoc comments with reference to Discord docs"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update Discord provider to use enhanced embeds and incident data",
    "steps": [
      "Read the https://docs.slack.dev/messaging/formatting-message-text docs",
      "Open /packages/notifications/discord/src/index.ts",
      "Add @openstatus/notification-base to package.json dependencies",
      "Import buildCommonMessageData from @openstatus/notification-base",
      "Import buildAlertEmbed, buildRecoveryEmbed, buildDegradedEmbed from ./embeds",
      "Import Incident type from @openstatus/db/schema",
      "Update sendAlert function signature to accept incident?: Incident parameter",
      "In sendAlert: call buildCommonMessageData(context) to get formatted data",
      "In sendAlert: call buildAlertEmbed(data) to get embed object",
      "In sendAlert: send { embeds: [embed] } to webhook instead of current simple message",
      "Update sendRecovery function signature to accept incident?: Incident parameter",
      "In sendRecovery: call buildCommonMessageData(context, { includeIncidentDuration: true, incident }) to get formatted data",
      "In sendRecovery: call buildRecoveryEmbed(data) to get embed object",
      "In sendRecovery: send { embeds: [embed] } to webhook",
      "Update sendDegraded function signature to accept incident?: Incident parameter",
      "In sendDegraded: call buildCommonMessageData(context, { includeIncidentDuration: true, incident }) to get formatted data",
      "In sendDegraded: call buildDegradedEmbed(data) to get embed object",
      "In sendDegraded: send { embeds: [embed] } to webhook",
      "Remove biome-ignore comments for incidentId since we now use incident"
    ],
    "passes": true
  },
  {
    "category": "testing",
    "spec": "notifications-enhancement-spec.md",
    "description": "Add unit tests for duration formatting",
    "steps": [
      "Create test file for duration.ts utilities",
      "Test formatDuration with 30000ms expects '30s'",
      "Test formatDuration with 135000ms expects '2m 15s'",
      "Test formatDuration with 8130000ms expects '2h 15m 30s'",
      "Test formatDuration with 90000000ms expects '1d 1h'",
      "Test formatDuration with 0ms expects '0s' or similar",
      "Test edge cases for very long durations"
    ],
    "passes": true
  },
  {
    "category": "testing",
    "spec": "notifications-enhancement-spec.md",
    "description": "Add unit tests for incident duration calculation",
    "steps": [
      "Create test file for incident.ts utilities",
      "Test getIncidentDuration returns null when incident.startedAt is missing",
      "Test getIncidentDuration returns null when incident.resolvedAt is null (ongoing incident)",
      "Test getIncidentDuration calculates correct duration for resolved incident",
      "Mock incident with startedAt: 2026-01-22T10:00:00Z and resolvedAt: 2026-01-22T12:15:30Z, expect '2h 15m 30s'",
      "Test with Date objects and timestamp numbers"
    ],
    "passes": true
  },
  {
    "category": "testing",
    "spec": "notifications-enhancement-spec.md",
    "description": "Manual testing of Slack notifications",
    "steps": [
      "Configure a test monitor with Slack notification webhook",
      "Trigger alert notification and verify enhanced blocks appear with header, fields, error message in code block, and dashboard button",
      "Verify monitor name is a clickable link",
      "Wait for incident to have known duration",
      "Trigger recovery notification and verify incident duration displays correctly",
      "Verify all fields (Status, Region, Latency, Time) display properly in 2x2 grid",
      "Check mobile rendering to ensure blocks are responsive",
      "Trigger degraded notification and verify it displays correctly"
    ],
    "passes": false
  },
  {
    "category": "testing",
    "spec": "notifications-enhancement-spec.md",
    "description": "Manual testing of Discord notifications",
    "steps": [
      "Configure a test monitor with Discord notification webhook",
      "Trigger alert notification and verify red embed appears with proper fields",
      "Verify embed color is red (#ED4245 / 15548997)",
      "Verify monitor name in description is a clickable markdown link",
      "Verify Status/Region/Latency fields display inline (3 columns)",
      "Verify Error Message field displays full width (inline: false)",
      "Verify footer shows 'OpenStatus'",
      "Wait for incident to have known duration",
      "Trigger recovery notification and verify green embed with downtime field",
      "Verify embed color is green (#57F287 / 5763719)",
      "Verify downtime field shows correct duration",
      "Trigger degraded notification and verify yellow embed",
      "Verify embed color is yellow (#FEE75C / 16776960)"
    ],
    "passes": false
  },
  {
    "category": "documentation",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update package dependencies and workspace configuration",
    "steps": [
      "Add notification-base to root package.json workspaces array",
      "Run pnpm install or bun install to link workspace packages",
      "Verify @openstatus/notification-base can be imported in slack and discord packages",
      "Update /packages/notifications/slack/package.json to include @openstatus/notification-base dependency",
      "Update /packages/notifications/discord/package.json to include @openstatus/notification-base dependency",
      "Update /apps/workflows/package.json to include @openstatus/notification-base dependency if needed"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "spec": "notifications-enhancement-spec.md",
    "description": "Verify backward compatibility with other notification providers",
    "steps": [
      "Ensure email notifications still work (they don't use incident data yet)",
      "Ensure google-chat notifications still work",
      "Ensure telegram notifications still work",
      "Ensure pagerduty notifications still work",
      "Ensure opsgenie notifications still work",
      "Ensure ntfy notifications still work",
      "Ensure webhook notifications still work",
      "Ensure twillio-sms notifications still work",
      "Ensure twillio-whatsapp notifications still work",
      "All providers should gracefully ignore the new optional incident parameter"
    ],
    "passes": false
  },
  {
    "category": "validation",
    "spec": "notifications-enhancement-spec.md",
    "description": "End-to-end validation of incident duration flow",
    "steps": [
      "Create a test monitor that will fail",
      "Trigger monitor failure to create incident with startedAt timestamp",
      "Verify incident is created in database with correct startedAt",
      "Verify alert notifications are sent WITHOUT duration (incident not resolved yet)",
      "Wait 5 minutes (or manually advance time in test)",
      "Trigger monitor recovery to resolve incident with resolvedAt timestamp",
      "Verify incident is marked as resolved in database with autoResolved: true",
      "Verify recovery notifications are sent WITH duration showing '5m' (or actual duration)",
      "Check Slack message shows '‚è±Ô∏è Downtime: 5m' section",
      "Check Discord embed shows '‚è±Ô∏è Downtime' field with '5m' value",
      "Verify duration calculation matches resolvedAt - startedAt"
    ],
    "passes": false
  },
  {
    "category": "validation",
    "spec": "notifications-enhancement-spec.md",
    "description": "Validate character escaping and special formatting",
    "steps": [
      "Test Slack notifications with monitor names containing &, <, > characters",
      "Verify special characters are properly escaped as &amp;, &lt;, &gt;",
      "Test Discord notifications with markdown-like text in monitor names",
      "Verify Discord markdown links work correctly in embed descriptions",
      "Test error messages with special characters in both providers",
      "Verify code blocks in Slack properly display error messages",
      "Test very long error messages to ensure they don't break formatting"
    ],
    "passes": false
  },
  {
    "category": "performance",
    "spec": "notifications-enhancement-spec.md",
    "description": "Verify database query performance for incident fetching",
    "steps": [
      "Monitor database query time for fetching incident by ID",
      "Ensure query is using primary key index (should be <1ms)",
      "Verify query only runs for recovery and degraded notifications, not alerts",
      "Check that missing incidents don't cause notifications to fail",
      "Verify error handling when incident ID is invalid or incident doesn't exist"
    ],
    "passes": false
  },
  {
    "category": "documentation",
    "spec": "notifications-enhancement-spec.md",
    "description": "Update implementation based on official documentation guidelines",
    "steps": [
      "Reference Slack formatting docs: https://docs.slack.dev/messaging/formatting-message-text",
      "Follow Slack Block Kit best practices: use mrkdwn for formatted text, plain_text for buttons/headers",
      "Reference Discord embed docs: https://birdie0.github.io/discord-webhooks-guide/structure/embeds.html",
      "Follow Discord guidelines: max 25 fields per embed, footer text has no markdown, use ISO 8601 timestamps",
      "Ensure inline fields create proper 3-column layouts in Discord",
      "Use proper color values (decimal, not hex) for Discord embeds"
    ],
    "passes": false
  },
  {
    "category": "validation",
    "spec": "notifications-enhancement-spec.md",
    "description": "Verify all notification providers have the newly created utils/types",
    "steps": [
      "Check /packages/notifications/slack package for @openstatus/notification-base dependency and usage",
      "Check /packages/notifications/discord package for @openstatus/notification-base dependency and usage",
      "Review /packages/notifications/email to determine if it should use the new utils/types",
      "Review /packages/notifications/google-chat to determine if it should use the new utils/types",
      "Review /packages/notifications/telegram to determine if it should use the new utils/types",
      "Review /packages/notifications/pagerduty to determine if it should use the new utils/types",
      "Review /packages/notifications/opsgenie to determine if it should use the new utils/types",
      "Review /packages/notifications/ntfy to determine if it should use the new utils/types",
      "Review /packages/notifications/webhook to determine if it should use the new utils/types",
      "Review /packages/notifications/twillio-sms to determine if it should use the new utils/types",
      "Review /packages/notifications/twillio-whatsapp to determine if it should use the new utils/types",
      "Verify all providers import types from @openstatus/notification-base where applicable",
      "Verify function signatures match the updated NotificationContext types",
      "Create a checklist or document of which providers use the new utilities and which don't",
      "Document any providers that need updates to use the new utils/types"
    ],
    "passes": false
  }
]
