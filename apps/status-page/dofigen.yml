builders:
  # Stage 1: Next.js build with Node.js
  builder:
    fromImage: node:24-slim
    workdir: /app
    copy:
      - . /app/
    env:
      NODE_ENV: production
      PNPM_HOME: /pnpm
      PATH: $PNPM_HOME:$PATH
      # Build-time environment variables (placeholder values, overwritten by .env.docker at runtime)
      NEXT_PUBLIC_OPENPANEL_CLIENT_ID: ""
      DATABASE_URL: http://libsql:8080
    run:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm turbo run build --filter=@openstatus/status-page

# Runtime stage
fromImage: node:24-slim
workdir: /app/apps/status-page

# Copy artifacts from builder
copy:
  # Copy Next.js standalone output
  - fromBuilder: builder
    source: /app/apps/status-page/.next/standalone/apps/status-page/
    target: ./
    chmod: "555"
  # Copy root node_modules (required for pnpm symlinks)
  - fromBuilder: builder
    source: /app/node_modules/
    target: /app/node_modules/
  # Copy static assets
  - fromBuilder: builder
    source: /app/apps/status-page/.next/static/
    target: ./.next/static/
  # Copy public directory
  - fromBuilder: builder
    source: /app/apps/status-page/public/
    target: ./public/

# Security: run as non-root user
user: "1000:1000"

# Expose port
expose: "3000"

# Health check
healthcheck:
  interval: 30s
  timeout: 10s
  start: 45s
  retries: 3
  cmd: curl -f http://localhost:3000/api/health || exit 1

# Start application
cmd:
  - node
  - server.js
