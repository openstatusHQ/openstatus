builders:
  # Stage 1: Next.js build with Node.js
  builder:
    fromImage: node:24-slim
    workdir: /app
    copy:
      - . /app/
    env:
      NODE_ENV: production
      PNPM_HOME: /pnpm
      PATH: $PNPM_HOME:$PATH
      # Build-time environment variables from .env.docker
      DATABASE_URL: http://libsql:8080
      DATABASE_AUTH_TOKEN: test
      TINY_BIRD_API_KEY: test
      NEXT_PUBLIC_OPENPANEL_CLIENT_ID: test
      OPENPANEL_CLIENT_SECRET: test
    run:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm run --filter=@openstatus/status-page build

# Runtime
fromImage: node:24-slim
workdir: /app/apps/status-page

copy:
  # Copy Next.js standalone output
  - fromBuilder: builder
    source: /app/apps/status-page/.next/standalone/apps/status-page/
    target: ./
    chmod: "555"
  # Copy root node_modules (required for pnpm symlinks)
  - fromBuilder: builder
    source: /app/node_modules/
    target: /app/node_modules/
  # Copy static assets
  - fromBuilder: builder
    source: /app/apps/status-page/.next/static/
    target: ./.next/static/
  # Copy public directory
  - fromBuilder: builder
    source: /app/apps/status-page/public/
    target: ./public/

expose: "3000"
user: 1000:1000

healthcheck:
  interval: 30s
  timeout: 10s
  start: 45s
  retries: 3
  cmd: curl -f http://localhost:3000/api/health || exit 1

cmd:
  - node
  - server.js
