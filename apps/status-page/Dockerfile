# syntax=docker/dockerfile:1.11
# This file is generated by Dofigen v2.5.1
# See https://github.com/lenra-io/dofigen

# builder
FROM node@sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2 AS builder
LABEL \
    org.opencontainers.image.base.digest="sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2" \
    org.opencontainers.image.base.name="docker.io/node:24-slim"
ENV \
    PATH="$PNPM_HOME:$PATH" \
    CRON_SECRET="test" \
    RESEND_API_KEY="test" \
    STRIPE_SECRET_KEY="test" \
    TINY_BIRD_API_KEY="test" \
    TEAM_ID_VERCEL="test" \
    PROJECT_ID_VERCEL="test" \
    SELF_HOST="true" \
    NODE_ENV="production" \
    NEXT_PUBLIC_OPENPANEL_CLIENT_ID="test" \
    OPENPANEL_CLIENT_SECRET="test" \
    NEXT_PUBLIC_URL="http://localhost:3002" \
    UNKEY_TOKEN="test" \
    RANDOM_YOLO="YOLO" \
    UPSTASH_REDIS_REST_TOKEN="test" \
    UNKEY_API_ID="test" \
    DATABASE_URL="http://libsql:8080" \
    UPSTASH_REDIS_REST_URL="test" \
    VERCEL_AUTH_BEARER_TOKEN="test" \
    PNPM_HOME="/pnpm" \
    DATABASE_AUTH_TOKEN="test"
WORKDIR /app
COPY \
    --link \
    "." "/app/"
RUN <<EOF
corepack enable
pnpm install --frozen-lockfile
pnpm turbo run build --filter=@openstatus/status-page
EOF

# runtime
FROM node@sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2 AS runtime
LABEL \
    io.dofigen.version="2.5.1" \
    org.opencontainers.image.base.digest="sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2" \
    org.opencontainers.image.base.name="docker.io/node:24-slim"
WORKDIR /app/apps/status-page
COPY \
    --from=builder \
    --chown=1000:1000 \
    --chmod=555 \
    --link \
    "/app/apps/status-page/.next/standalone/apps/status-page/" "./"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/node_modules/" "/app/node_modules/"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/apps/status-page/.next/static/" "./.next/static/"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/apps/status-page/public/" "./public/"
USER 0:0
RUN <<EOF
apt-get update
apt-get install -y --no-install-recommends curl
rm -rf /var/lib/apt/lists/*
EOF
USER 1000:1000
EXPOSE 3000
HEALTHCHECK \
    --interval=30s \
    --timeout=10s \
    --start-period=45s \
    --retries=3 \
    CMD curl -f http://localhost:3000/ || exit 1
CMD ["node", "server.js"]
