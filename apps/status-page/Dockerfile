# syntax=docker/dockerfile:1.11
# This file is generated by Dofigen v2.4.1
# See https://github.com/lenra-io/dofigen

# builder
FROM node@sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2 AS builder
LABEL \
    org.opencontainers.image.base.digest="sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2" \
    org.opencontainers.image.base.name="docker.io/node:24-slim"
ENV \
    OPENPANEL_CLIENT_SECRET="test" \
    TINY_BIRD_API_KEY="test" \
    DATABASE_URL="http://libsql:8080" \
    NODE_ENV="production" \
    PNPM_HOME="/pnpm" \
    PATH="$PNPM_HOME:$PATH" \
    DATABASE_AUTH_TOKEN="test" \
    NEXT_PUBLIC_OPENPANEL_CLIENT_ID="test"
WORKDIR /app
COPY \
    --link \
    "." "/app/"
RUN --mount=type=cache,target=/pnpm/store <<EOF
corepack enable
pnpm install --frozen-lockfile
pnpm run --filter=@openstatus/status-page build
EOF

# runtime
FROM node@sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2 AS runtime
LABEL \
    io.dofigen.version="2.4.1" \
    org.opencontainers.image.base.digest="sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2" \
    org.opencontainers.image.base.name="docker.io/node:24-slim"
WORKDIR /app/apps/status-page
COPY \
    --from=builder \
    --chown=1000:1000 \
    --chmod=555 \
    --link \
    "/app/apps/status-page/.next/standalone/apps/status-page/" "./"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/node_modules/" "/app/node_modules/"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/apps/status-page/.next/static/" "./.next/static/"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/app/apps/status-page/public/" "./public/"
USER 1000:1000
EXPOSE 3000
HEALTHCHECK \
    --interval=30s \
    --timeout=10s \
    --start-period=45s \
    --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1
CMD ["node", "server.js"]
