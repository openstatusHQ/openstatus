effective: |
  ignore:
  - node_modules
  - /apps/docs
  - /apps/screenshot-service
  - /apps/server
  - /apps/web
  - /apps/dashboard
  - /apps/status-page
  - /packages/analytics
  - /packages/api
  - /packages/error
  - /packages/tracker
  builders:
    libsql:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.stage: libsql
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      workdir: /app/
      copy:
      - fromBuilder: docker
        paths:
        - /app/apps/build-docker/package.json
        target: /app/package.json
      run:
      - bun install
    install:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
        org.opencontainers.image.stage: install
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
      workdir: /app/
      run:
      - bun install --production --frozen-lockfile --verbose
      cache:
      - target: /root/.bun/install/cache
      bind:
      - target: bunfig.toml
        source: bunfig.toml
      - target: package.json
        source: package.json
      - target: apps/workflows/package.json
        source: apps/workflows/package.json
      - target: packages/assertions/package.json
        source: packages/assertions/package.json
      - target: packages/db/package.json
        source: packages/db/package.json
      - target: packages/emails/package.json
        source: packages/emails/package.json
      - target: packages/notifications/discord/package.json
        source: packages/notifications/discord/package.json
      - target: packages/notifications/email/package.json
        source: packages/notifications/email/package.json
      - target: packages/notifications/ntfy/package.json
        source: packages/notifications/ntfy/package.json
      - target: packages/notifications/opsgenie/package.json
        source: packages/notifications/opsgenie/package.json
      - target: packages/notifications/pagerduty/package.json
        source: packages/notifications/pagerduty/package.json
      - target: packages/notifications/slack/package.json
        source: packages/notifications/slack/package.json
      - target: packages/notifications/twillio-sms/package.json
        source: packages/notifications/twillio-sms/package.json
      - target: packages/notifications/webhook/package.json
        source: packages/notifications/webhook/package.json
      - target: packages/regions/package.json
        source: packages/regions/package.json
      - target: packages/utils/package.json
        source: packages/utils/package.json
      - target: packages/tsconfig/package.json
        source: packages/tsconfig/package.json
      - target: packages/tinybird/package.json
        source: packages/tinybird/package.json
      - target: packages/upstash/package.json
        source: packages/upstash/package.json
      - target: packages/theme-store/package.json
        source: packages/theme-store/package.json
    docker:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.stage: docker
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
      workdir: /app/apps/workflows
      copy:
      - paths:
        - .
        target: /app/
      run:
      - bun run src/build-docker.ts
    ca-certs:
      fromImage:
        path: debian
        digest: sha256:52927eff8153b563244f98cdc802ba97918afcdf67f9e4867cbf1f7afb3d147b
      label:
        org.opencontainers.image.base.name: docker.io/debian:bullseye-slim
        org.opencontainers.image.stage: ca-certs
        org.opencontainers.image.base.digest: sha256:52927eff8153b563244f98cdc802ba97918afcdf67f9e4867cbf1f7afb3d147b
      run:
      - apt-get update && apt-get install -y --no-install-recommends ca-certificates && update-ca-certificates && rm -rf /var/lib/apt/lists/*
    build:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
        org.opencontainers.image.stage: build
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      workdir: /app/apps/workflows
      env:
        NODE_ENV: production
      copy:
      - paths:
        - .
        target: /app/
      - fromBuilder: install
        paths:
        - /app/node_modules
        target: /app/node_modules
      run:
      - bun build --compile --target bun --sourcemap --format=cjs src/index.ts --outfile=app --external '@libsql/*' --external libsql
  fromImage:
    path: debian
    digest: sha256:52927eff8153b563244f98cdc802ba97918afcdf67f9e4867cbf1f7afb3d147b
  label:
    io.dofigen.version: 2.5.1
    org.opencontainers.image.source: https://github.com/openstatusHQ/openstatus
    org.opencontainers.image.vendor: OpenStatus
    org.opencontainers.image.title: OpenStatus Workflows
    org.opencontainers.image.base.name: docker.io/debian:bullseye-slim
    org.opencontainers.image.base.digest: sha256:52927eff8153b563244f98cdc802ba97918afcdf67f9e4867cbf1f7afb3d147b
    org.opencontainers.image.description: Background job processing and probe scheduling for OpenStatus
    org.opencontainers.image.authors: OpenStatus Team
  user:
    user: '1000'
    group: '1000'
  workdir: /app/
  copy:
  - fromBuilder: build
    paths:
    - /app/apps/workflows/app
    target: /app/apps/workflows/
    chmod: '555'
  - fromBuilder: libsql
    paths:
    - /app/node_modules
    target: /app/packages/db/node_modules
  - fromBuilder: libsql
    paths:
    - /app/node_modules
    target: /app/node_modules
  - fromBuilder: ca-certs
    paths:
    - /etc/ssl/certs/ca-certificates.crt
    target: /etc/ssl/certs/
  entrypoint:
  - /app/apps/workflows/app
  expose:
  - port: 3000
  healthcheck:
    cmd: curl -f http://localhost:3000/health || exit 1
    interval: 30s
    timeout: 10s
    start: 30s
    retries: 3
images:
  docker.io:
    oven:
      bun:
        1.3.0:
          digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
    library:
      debian:
        bullseye-slim:
          digest: sha256:52927eff8153b563244f98cdc802ba97918afcdf67f9e4867cbf1f7afb3d147b
resources:
  dofigen.yml:
    hash: aadfda126c49a8894f301c8fdc198d2a17f5c709f886f326a9544cc24da19a75
    content: "# Files to exclude from Docker context\nignore:\n  - node_modules\n  - /apps/docs\n  - /apps/screenshot-service\n  - /apps/server\n  - /apps/web\n  - /apps/dashboard\n  - /apps/status-page\n  - /packages/analytics\n  - /packages/api\n  - /packages/error\n  - /packages/tracker\n\nbuilders:\n  # Stage 1: CA Certificates\n  ca-certs:\n    fromImage: debian:bullseye-slim\n    labels:\n      org.opencontainers.image.stage: ca-certs\n    run: apt-get update && apt-get install -y --no-install-recommends ca-certificates && update-ca-certificates && rm -rf /var/lib/apt/lists/*\n\n  # Stage 2: Install production dependencies\n  install:\n    fromImage: oven/bun:1.3.0\n    workdir: /app/\n    labels:\n      org.opencontainers.image.stage: install\n    bind:\n      - bunfig.toml\n      - package.json\n      - apps/workflows/package.json\n      - packages/assertions/package.json\n      - packages/db/package.json\n      - packages/emails/package.json\n      - packages/notifications/discord/package.json\n      - packages/notifications/email/package.json\n      - packages/notifications/ntfy/package.json\n      - packages/notifications/opsgenie/package.json\n      - packages/notifications/pagerduty/package.json\n      - packages/notifications/slack/package.json\n      - packages/notifications/twillio-sms/package.json\n      - packages/notifications/webhook/package.json\n      - packages/regions/package.json\n      - packages/utils/package.json\n      - packages/tsconfig/package.json\n      - packages/tinybird/package.json\n      - packages/upstash/package.json\n      - packages/theme-store/package.json\n    run: bun install --production --frozen-lockfile --verbose\n    cache:\n      - /root/.bun/install/cache\n\n  # Stage 3: Build application (compile to binary)\n  build:\n    fromImage: oven/bun:1.3.0\n    workdir: /app/apps/workflows\n    labels:\n      org.opencontainers.image.stage: build\n    env:\n      NODE_ENV: production\n    copy:\n      - . /app/\n      - fromBuilder: install\n        source: /app/node_modules\n        target: /app/node_modules\n    run: bun build --compile --target bun --sourcemap --format=cjs src/index.ts --outfile=app --external '@libsql/*' --external libsql\n\n  # Stage 4: Docker-specific build artifacts\n  docker:\n    fromImage: oven/bun:1.3.0\n    workdir: /app/apps/workflows\n    labels:\n      org.opencontainers.image.stage: docker\n    copy:\n      - . /app/\n    run: bun run src/build-docker.ts\n\n  # Stage 5: LibSQL dependencies\n  libsql:\n    fromImage: oven/bun:1.3.0\n    workdir: /app/\n    labels:\n      org.opencontainers.image.stage: libsql\n    copy:\n      - fromBuilder: docker\n        source: /app/apps/build-docker/package.json\n        target: /app/package.json\n    run: bun install\n\n# Final Runtime Stage\nfromImage: debian:bullseye-slim\nworkdir: /app/\n\n# Metadata labels\nlabels:\n  org.opencontainers.image.title: OpenStatus Workflows\n  org.opencontainers.image.description: Background job processing and probe scheduling for OpenStatus\n  org.opencontainers.image.source: https://github.com/openstatusHQ/openstatus\n  org.opencontainers.image.vendor: OpenStatus\n  org.opencontainers.image.authors: OpenStatus Team\n\n# Copy artifacts from build stages\ncopy:\n  - fromBuilder: build\n    source: /app/apps/workflows/app\n    target: /app/apps/workflows/\n    chmod: \"555\"\n  - fromBuilder: libsql\n    source: /app/node_modules\n    target: /app/packages/db/node_modules\n  - fromBuilder: libsql\n    source: /app/node_modules\n    target: /app/node_modules\n  - fromBuilder: ca-certs\n    source: /etc/ssl/certs/ca-certificates.crt\n    target: /etc/ssl/certs/\n  \n# Security: run as non-root user\nuser: \"1000:1000\"\n\n# Expose port\nexpose: \"3000\"\n\n# Health check\nhealthcheck:\n  interval: 30s\n  timeout: 10s\n  start: 30s\n  retries: 3\n  cmd: curl -f http://localhost:3000/health || exit 1\n\n# Start application\nentrypoint: /app/apps/workflows/app\n"
