effective: |
  ignore:
  - node_modules
  - /apps/docs
  - /apps/screenshot-service
  - /apps/server
  - /apps/web
  - /apps/dashboard
  - /apps/status-page
  - /packages/analytics
  - /packages/api
  - /packages/error
  - /packages/tracker
  builders:
    a-ca-certs:
      fromImage:
        path: debian
        digest: sha256:530a3348fc4b5734ffe1a137ddbcee6850154285251b53c3425c386ea8fac77b
      label:
        org.opencontainers.image.base.digest: sha256:530a3348fc4b5734ffe1a137ddbcee6850154285251b53c3425c386ea8fac77b
        org.opencontainers.image.base.name: docker.io/debian:bullseye-slim
        org.opencontainers.image.stage: ca-certs
      run:
      - apt-get update && apt-get install -y --no-install-recommends ca-certificates && update-ca-certificates && rm -rf /var/lib/apt/lists/*
    d-build:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.stage: build
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
      workdir: /app/apps/workflows
      env:
        NODE_ENV: production
      copy:
      - paths:
        - .
        target: /app/
      - fromBuilder: c-install
        paths:
        - /app/node_modules
        target: /app/node_modules
      run:
      - mkdir -p /app/data
      - bun build --compile --target bun --sourcemap --format=cjs src/index.ts --outfile=app --external '@libsql/*' --external libsql
    c-install:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
        org.opencontainers.image.stage: install
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      workdir: /app/
      run:
      - bun install --production --frozen-lockfile --verbose
      cache:
      - target: /root/.bun/install/cache
      bind:
      - target: bunfig.toml
        source: bunfig.toml
      - target: package.json
        source: package.json
      - target: apps/workflows/package.json
        source: apps/workflows/package.json
      - target: packages/assertions/package.json
        source: packages/assertions/package.json
      - target: packages/db/package.json
        source: packages/db/package.json
      - target: packages/emails/package.json
        source: packages/emails/package.json
      - target: packages/notifications/discord/package.json
        source: packages/notifications/discord/package.json
      - target: packages/notifications/email/package.json
        source: packages/notifications/email/package.json
      - target: packages/notifications/ntfy/package.json
        source: packages/notifications/ntfy/package.json
      - target: packages/notifications/opsgenie/package.json
        source: packages/notifications/opsgenie/package.json
      - target: packages/notifications/pagerduty/package.json
        source: packages/notifications/pagerduty/package.json
      - target: packages/notifications/slack/package.json
        source: packages/notifications/slack/package.json
      - target: packages/notifications/twillio-sms/package.json
        source: packages/notifications/twillio-sms/package.json
      - target: packages/notifications/webhook/package.json
        source: packages/notifications/webhook/package.json
      - target: packages/regions/package.json
        source: packages/regions/package.json
      - target: packages/utils/package.json
        source: packages/utils/package.json
      - target: packages/tsconfig/package.json
        source: packages/tsconfig/package.json
      - target: packages/tinybird/package.json
        source: packages/tinybird/package.json
      - target: packages/upstash/package.json
        source: packages/upstash/package.json
      - target: packages/theme-store/package.json
        source: packages/theme-store/package.json
    e-libsql:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
        org.opencontainers.image.stage: libsql
      workdir: /app/
      copy:
      - fromBuilder: b-docker
        paths:
        - /app/apps/build-docker/package.json
        target: /app/package.json
      run:
      - bun install
    b-docker:
      fromImage:
        path: oven/bun
        digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
      label:
        org.opencontainers.image.base.digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
        org.opencontainers.image.base.name: docker.io/oven/bun:1.3.0
        org.opencontainers.image.stage: docker
      workdir: /app/apps/workflows
      copy:
      - paths:
        - .
        target: /app/
      run:
      - bun run src/build-docker.ts
  fromImage:
    path: debian
    digest: sha256:530a3348fc4b5734ffe1a137ddbcee6850154285251b53c3425c386ea8fac77b
  label:
    org.opencontainers.image.description: Background job processing and probe scheduling for OpenStatus
    org.opencontainers.image.authors: OpenStatus Team
    org.opencontainers.image.source: https://github.com/openstatusHQ/openstatus
    org.opencontainers.image.base.digest: sha256:530a3348fc4b5734ffe1a137ddbcee6850154285251b53c3425c386ea8fac77b
    org.opencontainers.image.vendor: OpenStatus
    org.opencontainers.image.base.name: docker.io/debian:bullseye-slim
    io.dofigen.version: 2.4.1
    org.opencontainers.image.title: OpenStatus Workflows
  user:
    user: '1000'
    group: '1000'
  workdir: /app/
  copy:
  - fromBuilder: d-build
    paths:
    - /app/apps/workflows/app
    target: /app/apps/workflows/
    chmod: '555'
  - fromBuilder: d-build
    paths:
    - /app/data
    target: /app/data
  - fromBuilder: e-libsql
    paths:
    - /app/node_modules
    target: /app/packages/db/node_modules
  - fromBuilder: e-libsql
    paths:
    - /app/node_modules
    target: /app/node_modules
  - fromBuilder: a-ca-certs
    paths:
    - /etc/ssl/certs/ca-certificates.crt
    target: /etc/ssl/certs/
  entrypoint:
  - /app/apps/workflows/app
  expose:
  - port: 3000
  healthcheck:
    cmd: curl -f http://localhost:3000/health || exit 1
    interval: 30s
    timeout: 10s
    start: 30s
    retries: 3
images:
  docker.io:
    library:
      debian:
        bullseye-slim:
          digest: sha256:530a3348fc4b5734ffe1a137ddbcee6850154285251b53c3425c386ea8fac77b
    oven:
      bun:
        1.3.0:
          digest: sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025
resources:
  dofigen.yml:
    hash: 1fadb130936597ac3125cf17dbcf984120a717fabb27eadb0265d9f457130760
    content: |
      # IMPORTANT: Stages are prefixed with letters (a-, b-, c-, d-, e-) to work around dofigen issue #429
      # (https://github.com/lenra-io/dofigen/issues/429) where stages are generated in random order.
      # The letter prefixes ensure alphabetical ordering matches the required dependency order.

      # Files to exclude from Docker context
      ignore:
        - node_modules
        - /apps/docs
        - /apps/screenshot-service
        - /apps/server
        - /apps/web
        - /apps/dashboard
        - /apps/status-page
        - /packages/analytics
        - /packages/api
        - /packages/error
        - /packages/tracker

      builders:
        # Stage 1: CA Certificates
        a-ca-certs:
          fromImage: debian:bullseye-slim
          labels:
            org.opencontainers.image.stage: ca-certs
          run: apt-get update && apt-get install -y --no-install-recommends ca-certificates && update-ca-certificates && rm -rf /var/lib/apt/lists/*

        # Stage 2: Docker-specific build artifacts (no dependencies)
        b-docker:
          fromImage: oven/bun:1.3.0
          workdir: /app/apps/workflows
          labels:
            org.opencontainers.image.stage: docker
          copy:
            - . /app/
          run: bun run src/build-docker.ts

        # Stage 3: Install production dependencies
        c-install:
          fromImage: oven/bun:1.3.0
          workdir: /app/
          labels:
            org.opencontainers.image.stage: install
          bind:
            - bunfig.toml
            - package.json
            - apps/workflows/package.json
            - packages/assertions/package.json
            - packages/db/package.json
            - packages/emails/package.json
            - packages/notifications/discord/package.json
            - packages/notifications/email/package.json
            - packages/notifications/ntfy/package.json
            - packages/notifications/opsgenie/package.json
            - packages/notifications/pagerduty/package.json
            - packages/notifications/slack/package.json
            - packages/notifications/twillio-sms/package.json
            - packages/notifications/webhook/package.json
            - packages/regions/package.json
            - packages/utils/package.json
            - packages/tsconfig/package.json
            - packages/tinybird/package.json
            - packages/upstash/package.json
            - packages/theme-store/package.json
          run: bun install --production --frozen-lockfile --verbose
          cache:
            - /root/.bun/install/cache

        # Stage 4: Build application (compile to binary) - depends on install
        d-build:
          fromImage: oven/bun:1.3.0
          workdir: /app/apps/workflows
          labels:
            org.opencontainers.image.stage: build
          env:
            NODE_ENV: production
          copy:
            - . /app/
            - fromBuilder: c-install
              source: /app/node_modules
              target: /app/node_modules
          run:
            - mkdir -p /app/data
            - bun build --compile --target bun --sourcemap --format=cjs src/index.ts --outfile=app --external '@libsql/*' --external libsql

        # Stage 5: LibSQL dependencies - depends on docker
        e-libsql:
          fromImage: oven/bun:1.3.0
          workdir: /app/
          labels:
            org.opencontainers.image.stage: libsql
          copy:
            - fromBuilder: b-docker
              source: /app/apps/build-docker/package.json
              target: /app/package.json
          run: bun install

      # Runtime
      fromImage: debian:bullseye-slim
      workdir: /app/

      # Metadata labels
      labels:
        org.opencontainers.image.title: OpenStatus Workflows
        org.opencontainers.image.description: Background job processing and probe scheduling for OpenStatus
        org.opencontainers.image.source: https://github.com/openstatusHQ/openstatus
        org.opencontainers.image.vendor: OpenStatus
        org.opencontainers.image.authors: OpenStatus Team

      # Copy artifacts from build stages
      copy:
        - fromBuilder: d-build
          source: /app/apps/workflows/app
          target: /app/apps/workflows/
          chmod: "555"
        - fromBuilder: d-build
          source: /app/data
          target: /app/data
        - fromBuilder: e-libsql
          source: /app/node_modules
          target: /app/packages/db/node_modules
        - fromBuilder: e-libsql
          source: /app/node_modules
          target: /app/node_modules
        - fromBuilder: a-ca-certs
          source: /etc/ssl/certs/ca-certificates.crt
          target: /etc/ssl/certs/

      # Security: run as non-root user
      # IMPORTANT: After running `dofigen gen`, you MUST manually move the `RUN mkdir` command
      # in the Dockerfile to BEFORE the `USER 1000:1000` line. Dofigen issue #430
      # (https://github.com/lenra-io/dofigen/issues/430) causes USER to be generated before RUN,
      # which fails because the non-root user cannot create directories.
      user: "1000:1000"

      # Expose port
      expose: "3000"

      # Health check
      healthcheck:
        interval: 30s
        timeout: 10s
        start: 30s
        retries: 3
        cmd: curl -f http://localhost:3000/health || exit 1

      # Start application
      entrypoint: /app/apps/workflows/app
