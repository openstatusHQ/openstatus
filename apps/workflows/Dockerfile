# syntax=docker/dockerfile:1.11
# This file is generated by Dofigen v2.5.0
# See https://github.com/lenra-io/dofigen

# install
FROM oven/bun@sha256:6ebf306367da43ad75c4d5119563e24de9b66372929ad4fa31546be053a16f74 AS install
LABEL \
    org.opencontainers.image.base.digest="sha256:6ebf306367da43ad75c4d5119563e24de9b66372929ad4fa31546be053a16f74" \
    org.opencontainers.image.base.name="docker.io/oven/bun:1.2.23"
WORKDIR /app/
RUN \
    --mount=type=bind,target=package.json,source=package.json \
    --mount=type=bind,target=apps/workflows/package.json,source=apps/workflows/package.json \
    --mount=type=bind,target=packages/assertions/package.json,source=packages/assertions/package.json \
    --mount=type=bind,target=packages/db/package.json,source=packages/db/package.json \
    --mount=type=bind,target=packages/emails/package.json,source=packages/emails/package.json \
    --mount=type=bind,target=packages/notifications/discord/package.json,source=packages/notifications/discord/package.json \
    --mount=type=bind,target=packages/notifications/email/package.json,source=packages/notifications/email/package.json \
    --mount=type=bind,target=packages/notifications/ntfy/package.json,source=packages/notifications/ntfy/package.json \
    --mount=type=bind,target=packages/notifications/opsgenie/package.json,source=packages/notifications/opsgenie/package.json \
    --mount=type=bind,target=packages/notifications/pagerduty/package.json,source=packages/notifications/pagerduty/package.json \
    --mount=type=bind,target=packages/notifications/slack/package.json,source=packages/notifications/slack/package.json \
    --mount=type=bind,target=packages/notifications/twillio-sms/package.json,source=packages/notifications/twillio-sms/package.json \
    --mount=type=bind,target=packages/notifications/webhook/package.json,source=packages/notifications/webhook/package.json \
    --mount=type=bind,target=packages/regions/package.json,source=packages/regions/package.json \
    --mount=type=bind,target=packages/utils/package.json,source=packages/utils/package.json \
    --mount=type=bind,target=packages/tsconfig/package.json,source=packages/tsconfig/package.json \
    --mount=type=bind,target=packages/tinybird/package.json,source=packages/tinybird/package.json \
    --mount=type=bind,target=packages/upstash/package.json,source=packages/upstash/package.json \
    --mount=type=cache,target=/root/.bun/install/cache,sharing=locked \
    bun install --production --ignore-scripts --frozen-lockfile --verbose

# build
FROM oven/bun@sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025 AS build
LABEL \
    org.opencontainers.image.base.digest="sha256:00cccad6e9c66bbacc250851f689168606aaea551ac473e908bbcf00a5645025" \
    org.opencontainers.image.base.name="docker.io/oven/bun:latest"
ENV NODE_ENV="production"
WORKDIR /app/apps/workflows
COPY \
    --link \
    "." "/app/"
COPY \
    --from=install \
    --link \
    "/app/node_modules" "/app/node_modules"
RUN bun build --compile --sourcemap --format=cjs src/index.ts --outfile=app

# runtime
FROM debian@sha256:f807f4b16002c623115b0247dca6a55711c6b1ae821dc64fb8a2339e4ce2115d AS runtime
LABEL \
    io.dofigen.version="2.5.0" \
    org.opencontainers.image.base.digest="sha256:f807f4b16002c623115b0247dca6a55711c6b1ae821dc64fb8a2339e4ce2115d" \
    org.opencontainers.image.base.name="docker.io/debian:bullseye-slim"
COPY \
    --from=build \
    --chown=1000:1000 \
    --chmod=555 \
    --link \
    "/app/apps/workflows/app" "/bin/"
USER 1000:1000
EXPOSE 3000
ENTRYPOINT ["/bin/app"]
