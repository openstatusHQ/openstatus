effective: |
  builders:
    builder:
      fromImage:
        path: node
        digest: sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2
      label:
        org.opencontainers.image.base.name: docker.io/node:24-slim
        org.opencontainers.image.base.digest: sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2
      workdir: /app
      env:
        NODE_ENV: production
        PATH: $PNPM_HOME:$PATH
        NEXT_PUBLIC_URL: http://localhost:3002
        DATABASE_URL: http://libsql:8080
        AUTH_SECRET: build-time-placeholder-min-32-chars-long
        PNPM_HOME: /pnpm
        NEXT_PUBLIC_OPENPANEL_CLIENT_ID: ''
      copy:
      - paths:
        - .
        target: /app/
      run:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm run --filter=@openstatus/dashboard build
  fromImage:
    path: node
    digest: sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2
  label:
    io.dofigen.version: 2.5.1
    org.opencontainers.image.base.name: docker.io/node:24-slim
    org.opencontainers.image.base.digest: sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2
  user:
    user: '1000'
    group: '1000'
  workdir: /app/apps/dashboard
  copy:
  - fromBuilder: builder
    paths:
    - /app/apps/dashboard/.next/standalone/apps/dashboard/
    target: ./
    chmod: '555'
  - fromBuilder: builder
    paths:
    - /app/node_modules/
    target: /app/node_modules/
  - fromBuilder: builder
    paths:
    - /app/apps/dashboard/.next/static/
    target: ./.next/static/
  - fromBuilder: builder
    paths:
    - /app/apps/dashboard/public/
    target: ./public/
  cmd:
  - node
  - server.js
  expose:
  - port: 3000
  healthcheck:
    cmd: curl -f http://localhost:3000/api/health || exit 1
    interval: 30s
    timeout: 10s
    start: 45s
    retries: 3
images:
  docker.io:
    library:
      node:
        24-slim:
          digest: sha256:0afb7822fac7bf9d7c1bf3b6e6c496dee6b2b64d8dfa365501a3c68e8eba94b2
resources:
  dofigen.yml:
    hash: 11e8a7dde4240ac1b1bc11fbfc2cf552103eec78208dcd4c547756191d5af7ad
    content: |
      builders:
        # Stage 1: Next.js build with Node.js
        builder:
          fromImage: node:24-slim
          workdir: /app
          copy:
            - . /app/
          env:
            NODE_ENV: production
            PNPM_HOME: /pnpm
            PATH: $PNPM_HOME:$PATH
            # Build-time environment variables (placeholder values, overwritten by .env.docker at runtime)
            NEXT_PUBLIC_URL: http://localhost:3002
            NEXT_PUBLIC_OPENPANEL_CLIENT_ID: ""
            DATABASE_URL: http://libsql:8080
            AUTH_SECRET: build-time-placeholder-min-32-chars-long
          run:
            - corepack enable
            - pnpm install --frozen-lockfile
            - pnpm run --filter=@openstatus/dashboard build

      # Runtime stage
      fromImage: node:24-slim
      workdir: /app/apps/dashboard

      # Copy artifacts from builder
      copy:
        # Copy Next.js standalone output
        - fromBuilder: builder
          source: /app/apps/dashboard/.next/standalone/apps/dashboard/
          target: ./
          chmod: "555"
        # Copy root node_modules (required for pnpm symlinks)
        - fromBuilder: builder
          source: /app/node_modules/
          target: /app/node_modules/
        # Copy static assets
        - fromBuilder: builder
          source: /app/apps/dashboard/.next/static/
          target: ./.next/static/
        # Copy public directory
        - fromBuilder: builder
          source: /app/apps/dashboard/public/
          target: ./public/

      # Security: run as non-root user
      user: "1000:1000"

      # Expose port
      expose: "3000"

      # Health check
      healthcheck:
        interval: 30s
        timeout: 10s
        start: 45s
        retries: 3
        cmd: curl -f http://localhost:3000/api/health || exit 1

      # Start application
      cmd:
        - node
        - server.js
