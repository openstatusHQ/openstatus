# syntax=docker/dockerfile:1.19.0
# This file is generated by Dofigen v2.6.0
# See https://github.com/lenra-io/dofigen

# builder
FROM golang@sha256:d4c4845f5d60c6a974c6000ce58ae079328d03ab7f721a0734277e69905473e5 AS builder
ARG TARGETARCH
ARG TARGETOS
LABEL \
    org.opencontainers.image.base.digest="sha256:d4c4845f5d60c6a974c6000ce58ae079328d03ab7f721a0734277e69905473e5" \
    org.opencontainers.image.base.name="docker.io/golang:1.26-alpine" \
    org.opencontainers.image.stage="builder"
ENV \
    TZ="UTC" \
    CGO_ENABLED="0"
WORKDIR /go/src/app
COPY \
    --link \
    "." "."
RUN <<EOF
apk add --no-cache tzdata
go mod download
GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -trimpath -ldflags "-s -w" -o private-location ./cmd/server
EOF

# runtime
FROM alpine@sha256:5405e8f36ce1878720f71217d664aa3dea32e5e5df11acbf07fc78ef5661465b AS runtime
LABEL \
    io.dofigen.version="2.6.0" \
    org.opencontainers.image.authors="OpenStatus Team" \
    org.opencontainers.image.base.digest="sha256:5405e8f36ce1878720f71217d664aa3dea32e5e5df11acbf07fc78ef5661465b" \
    org.opencontainers.image.base.name="docker.io/alpine:3.21" \
    org.opencontainers.image.description="Private location orchestrator for OpenStatus" \
    org.opencontainers.image.source="https://github.com/openstatusHQ/openstatus" \
    org.opencontainers.image.title="OpenStatus Private Location" \
    org.opencontainers.image.vendor="OpenStatus"
ENV \
    GIN_MODE="release" \
    TZ="UTC" \
    USER="1000"
WORKDIR /opt/bin
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/etc/ssl/certs/ca-certificates.crt" "/etc/ssl/certs/"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/usr/share/zoneinfo" "/usr/share/zoneinfo"
COPY \
    --from=builder \
    --chown=1000:1000 \
    --link \
    "/go/src/app/private-location" "/opt/bin/private-location"
USER 1000:1000
EXPOSE 8080
HEALTHCHECK \
    --interval=15s \
    --timeout=10s \
    --start-period=30s \
    --retries=3 \
    CMD wget --spider -q http://localhost:8080/health || exit 1
CMD ["/opt/bin/private-location"]
